# Quick Create 404 Regression (2025-09-25)

## Incident Summary
- **Trigger:** Fresh sign-ups (e.g. Toolify referrals) hit `/projects/quick-create`, but are redirected to `/projects/<id>/generate` which immediately 404s.
- **Impact:** Every brand-new user loses their first workspace because the redirect lands on a missing project. Engagement pipeline is effectively broken for new traffic.

## Reproduction
1. Create a brand-new account (Google OAuth).
2. Post-auth redirect goes to `/projects/quick-create`.
3. QuickCreate auto-creates a project and navigates to `/projects/<uuid>/generate`.
4. Generate page throws `TRPCError: Project not found` (see prod logs 2025-09-25T12:22:08.588Z).

## Root Cause Analysis
1. `QuickCreatePage` auto-runs `api.project.create` when no projects exist, then redirects (`src/app/projects/quick-create/page.tsx:36-64`).
2. The same component immediately queues `api.project.pruneEmpty.mutate()` in a microtask after any redirect (`page.tsx:66-71`).
3. `pruneEmpty` deletes **all** projects with zero scenes for the current user (`src/server/api/routers/project.ts:137-156`).
4. Newly created workspaces start with zero scenes, so `pruneEmpty` removes the project right after it is created.
5. By the time `/projects/<id>/generate` loads, the project row has been deleted; `project.getFullProject` returns `null`, and we throw `NOT_FOUND` on the server (`project.ts:171-178` in generate page).

## Why This Escaped Earlier QA
- Logic worked for returning users because they already had a non-empty project; pruning deleted the brand-new project but they still had older ones, so the redirect fell back to another id.
- Toolify referrals exposed this because every account was new and lost its only workspace.

## Fix Recommendation
1. **Stop pruning immediately after creation.** Options:
   - Skip `pruneEmpty` when `reason === 'created'` (quickest patch).
   - Or update `pruneEmpty` to ignore projects created within the last N minutes or flagged `isWelcome = true`.
2. Add regression test: hit `project.create`, then `pruneEmpty`, assert new project survives until it has scenes.
3. Monitor: log deletions in `pruneEmpty` with project age + `isWelcome` to catch future regressions.

## Next Steps
- Patch `QuickCreatePage` to defer pruning until after at least one scene exists.
- Consider moving prune logic server-side (cron / scheduled job) with age threshold instead of client microtask.
- Add E2E coverage for first-project onboarding.

## Fix Implemented â€“ 2025-09-25
- Skipped the `pruneEmpty` microtask when the redirect reason is `created`, so fresh workspaces survive first load (`src/app/projects/quick-create/page.tsx`).
- Hardened `pruneEmpty` to ignore welcome projects, the project we just redirected into, and any project created in the last 15 minutes before deletion (`src/server/api/routers/project.ts`).
- Follow-up: cover with onboarding regression test and revisit longer-term pruning strategy (scheduled cleanup vs. on-demand).
