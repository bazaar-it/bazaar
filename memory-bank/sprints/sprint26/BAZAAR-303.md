BAZAAR-303 â€” â€œPublish & Shareâ€ Pipeline  ğŸš€

	
Sprint	27 (primary BE story)
Owner	Platform pod (â™Ÿ lead: you)
Depends on	302 (scenes in DB)
Parallels	304 (workspace UI)


â¸»

0 Â· TL;DR

Ship a one-click Publish button that:
	1.	Bundles a scene or an entire storyboard with esbuild.
	2.	Uploads the artifact to Cloudflare R2 (public-read).
	3.	Returns a permanent CDN URL and surfaces it in the UI (copy + open).
	4.	Runs off the request thread â€” user sees live status: â€œQueued â†’ Bundling â†’ Uploading â†’ Published âœ“â€.

â¸»

1 Â· Why
	â€¢	302 gives us near-instant preview, but everything is still local.
	â€¢	Users need a friction-free way to post an animation in Slack, Twitter, Loom, etc.
	â€¢	URLs must be immutable so later edits donâ€™t break already-shared links.

â¸»

2 Â· Goals & Scope (MVP)

Area	Goal
Bundling	Tree-shake React & Remotion externals; produce one ESM file + optional data-URIs (â‰¤10 kB). Bundler must work for (a) a single scene or (b) a stitched storyboard (future flag, default = scene).
Storage	Upload to R2 with deterministic key: projects/{projectId}/scenes/{sceneId}/{sha256}.js.
URL	Return public HTTPS URL (via Workers custom domain) â†’ store in scenes.published_url.
Status	Expose progress: queued â†’ bundling â†’ uploading â†’ published; UI polls or subscribes.
Async	All heavy lifting in a job queue (BullMQ ğŸ”Œ Redis preferred, Dexie fallback).
Permissions	Only owner / collaborators can publish; public URL is read-only.
Roll-forward	Re-publishing same scene emits a new hash; old links remain valid.
CI	Type-check & tests âœ….
Out of scope	Full video (FFmpeg) render; private/expiring links; transitions stitching (304).


â¸»

3 Â· Detailed Requirements

3.1 Backend

#	Item	Notes
B1	Bundler util â€“ packages/bundler/index.tsts
export async function bundleScene(sceneId: string, opts?: { fullStoryboard?: boolean }): Promise<{ bytes: Buffer; hash: string; size: number }>
 * esbuild (browser,esm,es2022), external react & remotion.  * Inline CSS/SVG/PNG â‰¤10 kB â†’ data URI.  * Optional fullStoryboard stitches scenes together via autogenerated index.tsx.	
B2	R2 client wrapper â€“ packages/r2/index.ts. Uses @aws-sdk/client-s3 with AWS_S3_FORCE_PATH_STYLE=1.	
B3	Job queue â€“ queues/publish.ts. States: queued â–¶ bundling â–¶ uploading â–¶ done â–¶ failed. Max runtime 60 s.	
B4	tRPCâ€¢ publishScene(sceneId, scope) â€“ enqueue, return jobId. â€¢ publishStatus(jobId) â€“ query or websocket subscription.	
B5	DB migration (drizzle):sql
ALTER TABLE scenes
ADD COLUMN published_url text,
ADD COLUMN published_hash text,
ADD COLUMN published_at timestamptz;
CREATE INDEX IF NOT EXISTS scene_publish_idx ON scenes(project_id, published_hash);
	
B6	Dedup: if hash already exists in R2, skip upload, immediately return URL.	

3.2 Frontend (GenerateWorkspace / GenerateVideoClient)
	1.	Publish button next to Compile & Test (disabled if scene has compile errors).
	2.	Click â†’ publishScene.
	3.	Sonner modal (or Sheet) shows live steps (poll every 1 s or subscribe).
	4.	Success â†’ green check, show URL with Copy & Open buttons; scene list shows link-icon.
	5.	On error â†’ red toast, â€œRetryâ€ button retains last jobId.

3.3 Security
	â€¢	Authorise scene ownership in both publishScene & job worker.
	â€¢	Bundle is generated server-side from DB code only â€“ never trust code shipped from client.

3.4 Instrumentation & Limits

Metric	Logged to
bundle size (B)	bunyan + scenes.published_size (optional column)
esbuild ms	same
upload ms	same
warn if size > 500 kB	toast on UI + bunyan warn


â¸»

4 Â· Task Breakdown

#	Task	Owner	Est.
T1	Bundler package + unit tests w/ fixture scene	BE	1 d
T2	R2 wrapper + env plumbing (R2_ACCESS_KEY â€¦)	BE	0.5 d
T3	Job queue infra (BullMQ; fallback Dexie)	BE	1 d
T4	DB migration + Drizzle models	BE	0.25 d
T5	tRPC publishScene / publishStatus (query & WS)	BE	0.5 d
T6	Front-end Publish UI (button, modal, polling)	FE	1 d
T7	Scene-list icon / URL surfacing	FE	0.25 d
T8	Unit tests: bundler (+ mock S3) & queue state	BE	0.5 d
T9	Cypress smoke: â€œgenerate â†’ publish â†’ open URLâ€	QA	0.5 d
T10	Docs: docs/publish-flow.md + README link	DX	0.25 d
Buffer	Fixes & polish	â€”	0.75 d

Total â‰ˆ 6.5 engineer-days â€” still one sprint.

â¸»

5 Â· Definition of Done
	1.	Publish works E2E in staging.
	2.	Re-publish creates new immutable URL (hash diff).
	3.	Bundle loads in standalone HTML page (imports window.React, window.Remotion).
	4.	Job status UI latency < 100 ms (polling or WS).
	5.	npm run typecheck clean.
	6.	Unit tests â‰¥ 90 % lines for bundler + R2 util.
	7.	Cypress happy-path passes.
	8.	Docs updated & linked.
	9.	CI green.

â¸»

6 Â· Risks & Mitigations

Risk	Mitigation
esbuild fails on exotic code	try/catch; pipe diagnostics back via job error + toast.
R2 creds / region wrong	start-up assert + health-check endpoint.
Bundle > 500 kB	warn & gzip; 305 will add code-splitting.
Long jobs block queue	per-job 60 s timeout; future ticket for async video render.
Hash collision / overwrite	SHA-256 of bytes; impossible collision for practical purposes.


â¸»

7 Â· Nice-to-Have (305+)
	â€¢	HTML â€œembed snippetâ€ generator with <script type="module" src="â€¦"></script>.
	â€¢	Publish entire storyboard with auto-transitions.
	â€¢	Private / expiring links & access analytics.
	â€¢	Cancel / retry buttons on job modal.

â¸»

8 Â· Alignment with Roadmap
	â€¢	302 â€“ scenes persisted âœ…
	â€¢	303 â€“ publish those scenes âœ… this ticket
	â€¢	304 â€“ new workspace UI with drag-reorder âœ… (parallel)
	â€¢	305 â€“ video render, transitions, analytics (future)

â¸»